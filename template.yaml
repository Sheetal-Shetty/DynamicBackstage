apiVersion: scaffolder.backstage.io/v1beta3
kind: Template
metadata:
  name: Github-pages-deploy-from-github
  title: Backstage Driven Internal Developer Platform
  description: Automates website deployment using Docker containers or GitHub Pages hosting.
spec:
  owner: user:guest
  type: service

  
  parameters:
    - title: GitHub Repository URL
      required: 
        - Github_URL
        #- Dockerfile
        #- Port
      properties:
        Github_URL:
          title: Enter you Github URL
          type: string
          description: Enter the github URL where your code exists
          ui:autofocus: true

    - title: Select where you want to deploy your code
      required:
        - stack
      properties:
        stack:
          title: Select from below list
          type: string
          enum:
            - Docker
            - Github pages
            - Baremetal
            - Kubernetes
  
    - title: Enter below details
      dependencies:
        stack:
          oneOf:
            - properties:
                stack:
                  const: Docker
                extraFields:          # ðŸ‘ˆ wrap everything else inside a schema key
                  title: Enter the details
                  type: object
                  properties:
                    Dockerfile:
                      title: Enter the Path of Docker-Compose file3
                      type: string
                      description: Enter the Dockercompose file path (e.g. build/docker-compose.yml or enter docker-compose.yml if it is in root) 
                      default: "docker-compose.yml" 
                    Port:
                      title: Enter the Port number
                      type: integer
                      minimum: 1
                      maximum: 65535
                      description: Enter the Port number of your application (e.g. 80/3000/5000)
  
            - properties:
                stack:
                  const: Github pages
                extraFields:
                  type: object
                  properties: 
                    # Github:
                    #   title: Enter the Path of Github Url
                    #   type: string
                    #   description: Enter the Github URL 
                      
                      
                    GithubToken:
                      title: Enter the Github Token
                      type: string
                      description: Enter the token
                       
  
            - properties:
                stack:
                  const: Baremetal
                extraFields:
                  type: object
                  properties: {}
  
            - properties:
                stack:
                  const: Kubernetes
                extraFields:
                  type: object
                  properties: {}
          
  steps:

  
    - id: fetch-template
      name: Fetch template files
      if: ${{ parameters.stack == 'Docker' }}
      action: shell:run
      input:
        command: git
        args: ["clone", "${{ parameters.Github_URL }}", "repo"]
        cwd: .
  
    # Deploy using docker-compose action: fetch:plain
    - id: deploy-docker
      name: Deploy Docker Compose
      if: ${{ parameters.stack == 'Docker' }}
      action: shell:run
      input:
        cwd: ./repo
        command: docker-compose
        args: ["-f", "${{ parameters.extraFields.Dockerfile }}", "up", "--build", "--no-ansi"]
        #, "--no-ansi", "-d"]

      # input:
      #   url: ${{ parameters.Github_URL }}
      #   targetPath: .

    # - id: build_docker_compose33
    #   name: Build Docker Compose33
    #   if: ${{ parameters.stack == 'Docker' }}
    #   action: shell:run
    #   input:
    #     cwd: ${{ steps.fetch-template.output.path }}
    #     command: docker-compose
    #     args: ["up", "--build"]
#################################################################################111-14-2025###########################################

    # - id: fetch-template
    #   name: Fetch template files
    #   if: ${{ parameters.stack == 'Docker' }}
    #   action: fetch:plain
    #   input:
    #     url: ${{ parameters.Github_URL }}
    #     targetPath: ./repo  # clone repo into ./repo

    # - id: fetch-repo2222
    #   name: Clone GitHub repository2222
    #   if: ${{ parameters.stack == 'Docker' }}
    #   action: shell:run
    #   input:
    #     command: bash
    #     args:
    #       - -c
    #       - |
    #         echo "Cloning repository..."
    #         git clone "${{ parameters.Github_URL }}" repo
    #         echo "Repo cloned:"
    #         ls -la repo
    
    # - id: debug_files
    #   name: Debug file listing
    #   if: ${{ parameters.stack == 'Docker' }}
    #   action: shell:run
    #   input:
    #     cwd: ./repo
    #     command: bash
    #     args:
    #       - -c
    #       - |
    #         echo "PWD: $(pwd)"
    #         echo "Listing files:"
    #         ls -la
    
    # - id: build_docker_compose2222
    #   name: Build & Run Docker Compose2222
    #   if: ${{ parameters.stack == 'Docker' }}
    #   action: shell:run
    #   input:
    #     cwd: ./repo
    #     command: docker
    #     args:
    #       - compose
    #       - -f
    #       - "${{ parameters.extraFields.Dockerfile }}"
    #       - up
    #       - --build
    #       - -d
          


    # - id: check_compose_file
    #   name: Check Compose File Exists
    #   if: ${{ parameters.stack == 'Docker' }}
    #   action: shell:run
    #   input:
    #     cwd: ./repo
    #     command: bash
    #     args:
    #       - -c
    #       - |
    #         if [ ! -f "${{ parameters.extraFields.Dockerfile }}" ]; then
    #           echo "âŒ docker-compose.yml not found in repo root!"
    #           exit 1
    #         fi

    
            
    
    # - id: debug_files
    #   name: Debug file listing
    #   if: ${{ parameters.stack == 'Docker' }}
    #   action: shell:run
    #   input:
    #     cwd: ${{ steps.fetch-template.output.path }}
    #     command: ls
    #     args:
    #       - -la
    
    # - id: check_docker_access
    #   name: Check Docker Access
    #   if: ${{ parameters.stack == 'Docker' }}
    #   action: shell:run
    #   input:
    #     command: docker
    #     args:
    #       - ps
    
    # - id: build_docker_compose
    #   name: Build & Run Docker Compose
    #   if: ${{ parameters.stack == 'Docker' }}
    #   action: shell:run
    #   input:
    #     cwd: ${{ steps.fetch-template.output.path }}
    #     command: docker
    #     args:
    #       - compose
    #       - -f
    #       - "${{ parameters.extraFields.Dockerfile }}"
    #       - up
    #       - --build
    #       - -d


    # - id: fetch-repo
    #   name: Clone GitHub repository
    #   if: ${{ parameters.stack == 'Docker' }}
    #   action: shell:run
    #   input:
    #     command: bash
    #     args:
    #       - -c
    #       - |
    #         echo "Cloning repository..."
    #         git clone "${{ parameters.Github_URL }}" repo
    #         echo "Repo cloned:"
    #         ls -la repo

    #########################################################################1.07PM######################################

    # - id: debug_files
    #   name: Debug file listing
    #   if: ${{ parameters.stack == 'Docker' }}
    #   action: shell:run
    #   input:
    #     cwd: repo
    #     command: bash
    #     args:
    #       - -c
    #       - |
    #         pwd
    #         ls -la

    # - id: build_docker_compose22
    #   name: Build Docker Compose
    #   if: ${{ parameters.stack == 'Docker' }}
    #   action: shell:run
    #   input:
    #     cwd: repo
    #     command: bash
    #     args:
    #       - -eo
    #       - pipefail
    #       - -c
    #       - |
    #           echo "--- Running Docker Compose ---"
    
    #           docker compose -f docker-compose.yml up --build
    #           exit_code=$?
    
    #           echo "=== Docker compose exited with: $exit_code ==="
    
    #           echo "--- Docker info ---"
    #           docker info || true
    
    #           echo "--- Docker version ---"
    #           docker version || true
    
    #           echo "--- Compose file ---"
    #           cat docker-compose.yml || true
    
    #           exit $exit_code


    # - id: build_docker
    #   name: Build Docker Compose
    #   if: ${{ parameters.stack == 'Docker' }}
    #   action: shell:run
    #   input:
    #     cwd: repo
    #     command: bash
    #     args:
    #       - -c
    #       - |
    #         set -e
    #         echo "Running Docker Compose..."
    
    #         if ! docker compose -f docker-compose.yml up --build; then
    #           echo "âŒ Docker Compose FAILED"
    #           echo "ðŸ” Docker info:"
    #           docker info || true
    
    #           echo "ðŸ” Docker version:"
    #           docker version || true
    
    #           echo "ðŸ” Compose file content:"
    #           cat docker-compose.yml || true
    
    #           exit 1
    #         fi



    


    
        
####################################################11-14-2025#####################################
    # - id: fetch-template
    #   name: Fetch template files
    #   if: ${{ parameters.stack == 'Docker' }}
    #   action: fetch:plain
    #   input:
    #     url: ${{ parameters.Github_URL }}
    #     targetPath: .

    # - id: debug_files
    #   name: Debug file listing
    #   if: ${{ parameters.stack == 'Docker' }}
    #   action: shell:run
    #   input:
    #     cwd: ${{ steps.fetch-template.output.path }}
    #     command: bash
    #     args:
    #       - -c
    #       - |
    #         echo "PWD: $(pwd)"
    #         echo "Listing files:"
    #         ls -la
        

    # - id: check_docker_access
    #   name: Check Docker Access
    #   if: ${{ parameters.stack == 'Docker' }}
    #   action: shell:run
    #   input:
    #     command: bash
    #     args:
    #       - -c
    #       - |
    #         echo "Docker socket status:"
    #         ls -l /var/run/docker.sock || echo "No socket found"
    #         docker ps || echo "Cannot connect to Docker daemon"

    # - id: build_docker2
    #   name: Build Docker Image (fallback)
    #   if: ${{ parameters.stack == 'Docker' }}
    #   action: shell:run
    #   input:
    #     cwd: ${{ steps.fetch-template.output.path }}
    #     command: bash
    #     args:
    #       - -c
    #       - |
    #         docker compose -f "${{ parameters.extraFields.Dockerfile }}" up --build

#############################################################################################################################################
    


    # - id: run_compose
    #   name: Run Docker Compose
    #   if: ${{ parameters.stack == 'Docker' }}
    #   action: shell:run
    #   input:
    #     cwd: ${{ steps.fetch-template.output.path }}
    #     command: bash
    #     args:
    #       - -c
    #       - |
    #         echo "ðŸ³ Current dir: $(pwd)"
    #         echo "ðŸ“‚ Listing files before running compose:"
    #         ls -la
    #         echo "âš™ï¸ Starting docker compose up..."
    #         DOCKER_HOST=unix:///var/run/docker.sock docker compose -f docker-compose.yml up -d --build --force-recreate --remove-orphans
    #         echo "âœ… Docker compose finished with exit code $?"
            # echo "ðŸ³ Current dir: $(pwd)"
            # echo "ðŸ“‚ Listing files before running compose:"
            # ls -la
            # echo "âš™ï¸ Starting docker compose up..."
            # DOCKER_HOST=unix:///var/run/docker.sock docker compose -f docker-compose.yml -f docker-compose.override.yml up --build --force-recreate --remove-orphans 2>&1
            # echo "âœ… Docker compose finished with exit code $?"


     
    # - id: build_docker
    #   name: Build Docker Image (fallback)
    #   if: ${{ parameters.stack == 'Docker' }}
    #   action: shell:run
    #   input:
    #     cwd: ${{ steps.fetch-template.output.path }}
    #     command: bash
    #     args:
    #       - -c
    #       - |
    #         echo "ðŸ³ Current dir: $(pwd)"
    #         echo "ðŸ“‚ Listing files:"
    #         ls -la
    #         echo "âš™ï¸ Starting docker compose build..."
    #         DOCKER_HOST=unix:///var/run/docker.sock docker compose up --build 2>&1
    #         echo "âœ… Compose command finished (exit code $?)"

    ###################################################################################################################################################################
        # cwd: ${{ steps.fetch-template.output.path }}
        # command: bash
        # args:
        #   - -c
        #   - |
        #     DOCKER_HOST=unix:///var/run/docker.sock docker compose up --build
        # command: docker
        # args: ["compose", "up", "--build", "--no-color"]
        # command: bash
        # args:
        #   - -c
        #   - |
        #     echo "Running in $(pwd)"
        #     docker ps || echo "âš ï¸ Docker daemon not reachable!"
        #     docker compose up --build



    #####################################################################################################################11-14-2025######################################    

    # - id: remove_existing
    #   name: Remove existing container on port 90
    #   if: ${{ parameters.stack == 'Docker' }}
    #   action: shell:run
    #   input:
    #     command: bash
    #     args:
    #       - -c
    #       - |
    #         echo "Checking for existing containers using port 90..."
    #         CONTAINER_ID=$(docker ps --filter "publish=90" --format "{{.ID}}")
    #         if [ -n "$CONTAINER_ID" ]; then
    #           echo "Stopping and removing container: $CONTAINER_ID"
    #           docker stop $CONTAINER_ID && docker rm $CONTAINER_ID
    #         else
    #           echo "No container running on port 90"
    #         fi

    # # Step 3: Create override file for port mapping
    # - id: override_ports
    #   name: Create port override file
    #   if: ${{ parameters.stack == 'Docker' }}
    #   action: shell:run
    #   input:
    #     command: bash
    #     args:
    #       - -c
    #       - |
    #         echo "Creating temporary docker-compose.override.yml with port mapping..."
    #         cat > docker-compose.override.yml <<EOF
    #         version: '3'
    #         services:
    #           web:
    #             ports:
    #               - "90:${{ parameters.extraFields.Port }}"
    #         EOF
###################################################################################################################################################################################

    # - id: build_docker
    #   name: Build and run docker containers
    #   action: shell:run
    #   input:
    #     command: bash
    #     args:
    #       - -c
    #       - |
    #         echo "Running docker-compose with override..."
    #         docker-compose -f "${{ parameters.Dockerfile }}" -f docker-compose.override.yml up --build -d
    # # Step 4: Build and run the container
    # - id: build_docker
    #   name: Build and run docker containers
    #   action: shell:run
    #   input:
    #     command: docker-compose
    #     args:
    #       - "-f"
    #       - "${{ parameters.Dockerfile }}"
    #       - "-f"
    #       - "docker-compose.override.yml"
    #       - "up"
    #       - "--build"
    #       - "-d"
######################################################################################################################################################
    # - id: check-files
    #   name: Check for docker-compose file
    #   if: ${{ parameters.stack == 'Docker' }}
    #   action: shell:run
    #   input:
    #     cwd: ${{ steps.fetch-template.output.path }}
    #     command: bash
    #     args:
    #       - -c
    #       - |
    #         echo "ðŸ“ Current directory: $(pwd)"
    #         echo "ðŸ” Listing files:"
    #         ls -la
    #         if [ -f docker-compose.yml ]; then
    #           echo "âœ… Found docker-compose.yml"
    #         else
    #           echo "âŒ docker-compose.yml not found!"
    #           exit 1
    #         fi
       ##################################################################################11-14-2025#######################   

    # - id: build_docker
    #   name: Build Docker Image4444444
    #   if: ${{ parameters.stack == 'Docker' }}
    #   action: shell:run
    #   input:
    #     cwd: ${{ steps.clone.output.path }}
    #     command: docker
    #     args: ["compose", "up"]
          # - -c
          # - |
          #   echo "ðŸ› ï¸ Running docker-compose build..."
          #   echo "ðŸ“ Current directory: $(pwd)"
          #   echo "ðŸ” Listing files:"
          #   ls -la
          #   echo "ðŸ§¾ Contents of docker-compose.yml:"
          #   cat docker-compose.yml
          #   echo "ðŸ§¾ Contents of docker-compose.override.yml (if any):"
          #   cat docker-compose.override.yml || echo "No override file"
          #   docker-compose up --build --force-recreate --verbose

        #args: ["up", "--build", "-d"]
        #args: ["-f", "${{ parameters.extraFields.Dockerfile }}", "up", "--build"]
        # args: ["build", "-f", "${{ parameters.extraFields.Dockerfile }}", "-t", "my-image:latest", "."]


    # - id: cleanup
    #   name: Remove old container if exists
    #   if: ${{ parameters.stack == 'Docker' }}
    #   action: shell:run
    #   input:
    #     command: docker
    #     args: ["rm", "-f", "Cafe-container"]
                

    # - id: deploy_docker
    #   name: Deploy Docker Container
    #   if: ${{ parameters.stack == 'Docker' }}
    #   action: shell:run
    #   input:
    #     cwd: ${{ steps.clone.output.path }}
    #     command: docker
    #     args: ["run", "--name", "Cafe-container", "-it", "-d", "-p", "89:${{ parameters.extraFields.Port }}", "my-image:latest"] 

    - id: fetch
      name: Fetch GitHub Repo
      if: ${{ parameters.stack == 'Github pages' }}
      action: fetch:plain
      input:
        url: ${{ parameters.Github_URL }}
        targetPath: ./site  # fetch code into ./site folder

    # - id: build
    #   name: Build Project
    #   action: shell:run
    #   input:
    #     command: bash
    #     args:
    #       - -c
    #       - |
    #         set -euo pipefail
    #         echo "ðŸ“ Working directory: $(pwd)"
    #         echo "ðŸ” Detecting project type..."
    
    #         PACKAGE_JSON=$(find . -name package.json -print -quit || true)
    #         REQUIREMENTS=$(find . -name requirements.txt -print -quit || true)
    
    #         if [ -n "$PACKAGE_JSON" ]; then
    #           echo "ðŸ“¦ Node.js project detected at $PACKAGE_JSON"
    #           cd "$(dirname "$PACKAGE_JSON")"
    #           npm install
    #           npm run build || { echo "âŒ npm build failed"; exit 1; }
    
    #           if [ -d build ]; then
    #             mv build ../dist
    #           elif [ -d dist ]; then
    #             mv dist ../dist
    #           fi
    #           echo "âœ… Node.js build complete"
    
    #         elif [ -n "$REQUIREMENTS" ]; then
    #           echo "ðŸ Python project detected at $REQUIREMENTS"
    #           cd "$(dirname "$REQUIREMENTS")"
    #           pip install -r requirements.txt
    #           # optionally run python build step if you have one
    #           echo "âœ… Python dependencies installed"
    #           mkdir -p ../dist
    #           cp -r . ../dist
    
    #         elif [ -f "index.html" ]; then
    #           echo "ðŸŒ Static site detected, copying to dist..."
    #           mkdir -p ./dist
    #           cp -r ./* ./dist
    #           echo "âœ… Static site ready"
    
    #         else
    #           echo "âš ï¸ Unknown project type, skipping build."
    #         fi
    #     cwd: ./site
    

    - id: build
      name: Prepare Static Site
      if: ${{ parameters.stack == 'Github pages' }}
      action: shell:run
      input:
        command: bash
        args:
          - -c
          - |
            set -e
            echo "ðŸŒ Static site detected"
            echo "ðŸ“ Working directory: $(pwd)"
            echo "ðŸ“‚ Files present (excluding hidden):"
            find . -maxdepth 2 -not -path '*/.*'
    
            echo "ðŸ“¦ Creating ./dist folder"
            mkdir -p ./dist
    
            # Copy visible files from root if any
            if [ "$(ls -A | grep -v '^\.' | wc -l)" -gt 0 ]; then
              echo "ðŸ“‹ Copying files from root to ./dist..."
              rsync -av --exclude='.*' ./ ./dist/
            fi
    
            # Copy all non-hidden subfolders into dist
            SUBFOLDERS=$(find . -mindepth 1 -maxdepth 1 -type d -not -name '.*')
            for F in $SUBFOLDERS; do
              echo "ðŸ“‚ Copying contents of $F to ./dist..."
              rsync -av --exclude='.*' "$F"/ ./dist/
            done
    
            echo "âœ… All static files copied to ./dist successfully!"
        cwd: ./site
        

    - id: publish
      name: Deploy Static Site to GitHub Pages
      if: ${{ parameters.stack == 'Github pages' }}
      action: shell:run
      input:
        command: bash
        args:
          - -c
          - |
            set -e
            cd ./site/dist

            # Take the user input GitHub URL
            USER_URL="${{ parameters.Github_URL }}"
            
            # Remove trailing slash if present
            USER_URL="${USER_URL%/}"
            
            # Add token for authentication
            AUTH_URL="https://x-access-token:${{ parameters.extraFields.GithubToken }}@${USER_URL#https://}"

            git init
            git config user.email "backstage@automation.local"
            git config user.name "Backstage Bot"
            git remote add origin "$AUTH_URL"
            git checkout -b gh-pages || git checkout gh-pages
            git add .
            git commit -m "Deploy from Backstage Template"
            git push --force origin gh-pages

#########this is commented on 10-15-2025 at 11am to skip enable github pages
    # git remote add origin https://x-access-token:${{ parameters.extraFields.GithubToken }}@github.com/Meghana-shetty/CafeStaticWebsite.git
    # - id: enable-pages
    #   name: Enable GitHub Pages
    #   if: ${{ parameters.stack == 'Github pages' }}
    #   action: github:pages:enable
    #   input:
    #     repoUrl: ${{ parameters.extraFields.Github }}
    #     buildType: workflow
    #     sourceBranch: gh-pages
    #     sourcePath: /
    #     token: ${{ parameters.extraFields.GithubToken }}

##########commented on 10-15-2025 at 11am

#########below are previous code
    # - id: build
    #   name: Build Project
    #   action: shell:run
    #   input:
    #     command: bash
    #     args:
    #       - -c
    #       - |
    #         # Node.js
    #         PACKAGE_JSON=$(find . -name package.json -print -quit)
    #         if [ -n "$PACKAGE_JSON" ]; then
    #           cd $(dirname "$PACKAGE_JSON")
    #           npm install
    #           npm run build
    #           # Normalize output to ./dist
    #           if [ -d build ]; then mv build ../dist; elif [ -d dist ]; then mv dist ../dist; fi
    #         elif [ -f "index.html" ]; then
    #           # plain static site, just copy to ./dist
    #           mkdir -p ./dist
    #           cp -r ./* ./dist
    #         else
    #           echo "âš ï¸ Unknown project type; no build executed"
    #         fi
    #     cwd: ./site

   

    # - id: publish
    #   name: Publish to GitHub Pages
    #   action: publish:github
    #   input:
    #     repoUrl: ${{ parameters.extraFields.Github }}  # GitHub repo URL
    #     defaultBranch: gh-pages
    #     sourcePath: ./site/dist  # folder containing final static site
    #     protectDefaultBranch: false

    # - id: enable-pages
    #   name: Enable GitHub Pages
    #   if: ${{ parameters.stack == 'Github pages' }}
    #   action: github:pages:enable
    #   input:
    #     repoUrl: ${{ parameters.extraFields.Github }}
    #     buildType: workflow
    #     sourceBranch: gh-pages
    #     sourcePath: /
    #     token: ${{ parameters.extraFields.GithubToken }}


######till here############################################
    # - id: github-pages
    #   name: Enable GitHub Pages
    #   if: ${{ parameters.stack == 'Github pages' }}
    #   action: github:pages:enable
    #   input:
    #     repoUrl: ${{ parameters.extraFields.Github }} # github.com?repo=Cafe-static-last&owner=Meghana-shetty
    #     buildType: workflow
    #     sourceBranch: main
    #     sourcePath: /
    #     token: ${{ parameters.extraFields.GithubToken }}

  output:
    links:
      - title: "View on GitHub Pages"
        #if: "${{ parameters.deploy_method == 'github pages' }}"
        if: ${{ parameters.stack == 'Github pages' }}
        url: "https://${{ parameters.Github_URL | replace('https://github.com/', '') | replace('.git', '') | replace('/', '.github.io/') }}/"
        #url: ${{ steps.github-pages.output.pageUrl }}
        icon: "website"

      - title: "Open Website"
        if: ${{ parameters.stack == 'Docker' }}
        url: "http://localhost:89"
        icon: "website"
